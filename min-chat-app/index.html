<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Chatapp</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. FARGER OG INNSTILLINGER (CSS VARIABLER) --- */
        /* :root er som "innstillinger" for hele nettsiden. 
           Her bestemmer vi hva "farge-1", "farge-2" osv. skal være.
           Hvis vi endrer en farge her, endres den overalt!
        */
        :root {
            /* LYS MODUS (Standard farger) */
            --bg-app: #ffffff;       /* Bakgrunn på hele siden */
            --bg-panel: #f7f8fa;     /* Bakgrunn på menyene */
            --tekst-hoved: #1a1a1a;  /* Vanlig tekstfarge */
            --tekst-sekundær: #6b7280; /* Grå tekst (mindre viktig) */
            --primær: #4f46e5;       /* Hovedfargen (Blå/Lilla) */
            --primær-lys: #e0e7ff;   /* Lys variant av hovedfargen */
            --hover: #eef0f4;        /* Farge når man holder musen over noe */
            --input-bg: #ffffff;     /* Bakgrunn i skrivefeltet */
            --skygge: 0 4px 12px rgba(0, 0, 0, 0.05); /* En liten skygge for dybde */
            --border-radius: 16px;   /* Hvor runde hjørnene skal være */
        }

        /* Når vi skrur på "Dark Mode", legger vi klassen "dark-mode" på <body>.
           Da overskriver vi fargene over med disse mørke fargene i stedet.
        */
        body.dark-mode {
            --bg-app: #2f3136;
            --bg-panel: #202225;
            --tekst-hoved: #ffffff;
            --tekst-sekundær: #b9bbbe;
            --primær: #5865f2;
            --primær-lys: #3c3f45;
            --hover: #36393f;
            --input-bg: #40444b;
            --skygge: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* --- 2. GENERELT UTSEENDE --- */
        body { 
            margin: 0; 
            height: 100vh; /* 100vh betyr 100% av skjermhøyden */
            display: flex; /* Flex gjør at vi kan legge menyene ved siden av hverandre */
            font-family: 'Inter', sans-serif; 
            background: var(--bg-app); 
            color: var(--tekst-hoved); 
            overflow: hidden; /* Hindrer at hele nettsiden scroller (vi scroller bare inni boksene) */
        }
        
        /* Dette gjør at alle animasjoner (fargebytte osv) skjer mykt */
        * { box-sizing: border-box; outline: none; transition: background 0.2s, color 0.2s; }
        
        /* Gjør scrollbaren penere (mindre og grå) */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }

        /* --- 3. SIDEPANELER (Venstre og Høyre meny) --- */
        .sidebar { 
            width: 280px; 
            background: var(--bg-panel); 
            display: flex; 
            flex-direction: column; /* Ting inni menyen legges under hverandre */
            padding: 20px; 
            border-right: 1px solid rgba(0,0,0,0.03);
        }

        .header { 
            font-size: 0.75rem; font-weight: 700; letter-spacing: 1px;
            text-transform: uppercase; color: var(--tekst-sekundær); 
            margin-bottom: 15px; opacity: 0.8;
        }

        /* Listen inni menyen som kan scrolles */
        .list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }

        /* Knappene i listen (Kanaler/Brukere) */
        .item { 
            padding: 12px 16px; border-radius: 12px; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center; 
            color: var(--tekst-sekundær); font-weight: 500; font-size: 0.95rem;
        }
        .item:hover { background: var(--hover); color: var(--tekst-hoved); } /* Når musen er over */
        .active { background: var(--primær-lys); color: var(--primær); font-weight: 600; } /* Når den er valgt */

        /* Slette-ikonet (vises kun når man holder musen over .item) */
        .del-icon { font-size: 18px; opacity: 0; color: #ff5252; transition: 0.2s; }
        .item:hover .del-icon { opacity: 1; }

        /* Knapper nederst (+ Ny kanal osv) */
        .bottom-actions { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn-modern { 
            width: 100%; padding: 12px; border: none; border-radius: 12px;
            background: var(--hover); color: var(--tekst-hoved); font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-modern:hover { background: var(--primær); color: white; transform: translateY(-1px); }

        /* --- 4. CHAT OMRÅDE (Midten) --- */
        .chat-area { 
            flex: 1; /* Ta all gjenværende plass */
            display: flex; flex-direction: column; 
            background: var(--bg-app); position: relative; 
            min-width: 400px;
        }

        .chat-header { 
            height: 70px; padding: 0 30px; display: flex; align-items: center; 
            font-size: 1.2rem; font-weight: 700; 
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }

        /* Her kommer meldingene */
        .messages { 
            flex: 1; padding: 20px 30px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 10px; 
        }

        /* En enkelt melding-boble */
        .msg { 
            position: relative; padding: 10px 14px; border-radius: 12px;
            margin-bottom: 4px; transition: 0.1s;
        }
        .msg:hover { background: var(--hover); } /* Lyser opp når du peker på den */

        .msg-info { display: flex; align-items: baseline; gap: 10px; margin-bottom: 4px; }
        .author { font-weight: 600; color: var(--tekst-hoved); font-size: 0.95rem; }
        .time { font-size: 0.75rem; color: var(--tekst-sekundær); }
        .content { line-height: 1.5; color: var(--tekst-hoved); font-size: 1rem; }
        
        /* Bilder i chatten */
        .img-preview { 
            max-width: 350px; border-radius: 16px; margin-top: 10px; 
            box-shadow: var(--skygge); cursor: zoom-in; transition: transform 0.2s;
        }
        .img-preview:hover { transform: scale(1.02); } /* Zoomer litt når man peker */

        .msg-del { position: absolute; top: 10px; right: 15px; color: #ff5252; opacity: 0; cursor: pointer; }
        .msg:hover .msg-del { opacity: 1; }

        /* --- 5. SKRIVEFELT --- */
        .input-container { padding: 30px; background: transparent; }
        
        .input-box { 
            background: var(--input-bg); border-radius: 50px; /* Pilleform */
            display: flex; align-items: center; padding: 8px 10px; 
            box-shadow: var(--skygge); border: 1px solid rgba(0,0,0,0.05);
        }

        input[type="text"] { 
            flex: 1; background: transparent; border: none; 
            padding: 12px 15px; font-size: 1rem; color: var(--tekst-hoved); 
        }

        /* Runde knapper (Send / Bilde) */
        .circle-btn { 
            width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer;
            background: transparent; color: var(--tekst-sekundær); display: flex; 
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .circle-btn:hover { background: var(--primær-lys); color: var(--primær); }
        .send-btn { background: var(--primær); color: white; }
        .send-btn:hover { background: var(--tekst-hoved); color: white; }

        .status-txt { margin-top: 10px; margin-left: 20px; font-size: 0.85rem; color: var(--tekst-sekundær); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">Dine Kanaler</div>
        <div id="romListe" class="list"></div>
        
        <div class="bottom-actions">
            <button onclick="nyttRom()" class="btn-modern">
                <span class="material-icons-round">add</span> Ny Kanal
            </button>
            <button onclick="byttTema()" class="btn-modern">
                <span class="material-icons-round" id="temaIkon">dark_mode</span>
                <span id="temaTekst">Dark Mode</span>
            </button>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header" id="romTittel"># Velg en kanal</div>
        
        <div id="chatBox" class="messages">
            <div style="margin:auto; text-align:center; opacity:0.5;">
                <span class="material-icons-round" style="font-size: 48px;">chat_bubble_outline</span><br>
                Velg en kanal og en bruker for å starte.
            </div>
        </div>
        
        <div class="input-container">
            <div class="input-box">
                <input type="file" id="filInput" hidden>
                
                <button class="circle-btn" onclick="document.getElementById('filInput').click()" title="Send bilde">
                    <span class="material-icons-round">add_photo_alternate</span>
                </button>
                
                <input type="text" id="tekstInput" placeholder="Velg en bruker først..." disabled>
                
                <button class="circle-btn send-btn" onclick="send()">
                    <span class="material-icons-round">arrow_upward</span>
                </button>
            </div>
            <div class="status-txt">Du skriver som: <b id="brukerNavn" style="color:var(--primær)">Ingen valgt</b></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="header">Medlemmer</div>
        <div id="brukerListe" class="list"></div>
        
        <div class="bottom-actions">
            <button onclick="nyBruker()" class="btn-modern">
                <span class="material-icons-round">person_add</span> Ny Bruker
            </button>
        </div>
    </div>

    <script>
        // Adressen til serveren vår (Backend)
        const API = '';
        
        // Disse variablene husker hva brukeren har klikket på
        let romId = null; 
        let brukerId = null;

        // --- ENKLE HJELPEFUNKSJONER ---

        // Denne funksjonen bytter mellom lyst og mørkt tema
        function byttTema() {
            // .toggle() legger til klassen hvis den mangler, eller fjerner den hvis den er der
            document.body.classList.toggle('dark-mode');
            
            // Sjekk om vi er i dark mode nå, og bytt tekst/ikon på knappen
            const erMork = document.body.classList.contains('dark-mode');
            document.getElementById('temaTekst').innerText = erMork ? "Light Mode" : "Dark Mode";
            document.getElementById('temaIkon').innerText = erMork ? "light_mode" : "dark_mode";
        }

        // Lager en pen dato (f.eks "I dag 14:00")
        function dato(t) {
            const d = new Date(t.replace(" ", "T") + "Z");
            const kl = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            // Sjekker om datoen er i dag
            return (d.toDateString() === new Date().toDateString()) ? `I dag ${kl}` : `${d.toLocaleDateString()} ${kl}`;
        }

        // --- KOMMUNIKASJON MED SERVEREN (API) ---

        // 1. Hent alle rom fra serveren
        async function hentRom() {
            // "await fetch" betyr: Vent til serveren svarer før vi går videre
            const data = await (await fetch(API + '/rooms')).json();
            
            // Finn listen i HTML og tøm den
            const liste = document.getElementById('romListe');
            liste.innerHTML = '';
            
            // Gå gjennom hvert rom vi fikk fra serveren
            data.data.forEach(r => {
                const div = document.createElement('div');
                // Legg til klassen 'active' hvis dette er rommet vi står i
                div.className = `item ${r.id === romId ? 'active' : ''}`;
                div.innerHTML = `<span># ${r.navn}</span> <span class="material-icons-round del-icon">delete_outline</span>`;
                
                // Hva skjer når man klikker på rommet?
                div.onclick = (e) => {
                    // Hvis man trykket på søppelbøtta...
                    if (e.target.classList.contains('del-icon')) { 
                        if(confirm("Slette kanal?")) slett('room', r.id); 
                    } 
                    // Hvis man trykket på selve rommet...
                    else { 
                        romId = r.id; 
                        document.getElementById('romTittel').innerText = "# " + r.navn; 
                        hentRom(); // Oppdater menyen (for å flytte fargen)
                        hentMld(); // Last inn meldinger
                    }
                };
                liste.appendChild(div);
            });
        }

        // 2. Hent alle brukere fra serveren
        async function hentBrukere() {
            const data = await (await fetch(API + '/users')).json();
            const liste = document.getElementById('brukerListe');
            liste.innerHTML = '';

            data.data.forEach(b => {
                const div = document.createElement('div');
                div.className = `item ${b.id === brukerId ? 'active' : ''}`;
                div.innerHTML = `<span>${b.navn}</span> <span class="material-icons-round del-icon">person_remove</span>`;
                
                div.onclick = (e) => {
                    if (e.target.classList.contains('del-icon')) { 
                        if(confirm("Kaste ut?")) slett('user', b.id); 
                    }
                    else { 
                        // Velg brukeren
                        brukerId = b.id; 
                        document.getElementById('brukerNavn').innerText = b.navn;
                        // Nå har vi valgt bruker, så vi låser opp skrivefeltet
                        document.getElementById('tekstInput').disabled = false;
                        document.getElementById('tekstInput').placeholder = `Melding til #${document.getElementById('romTittel').innerText.substring(2)}...`;
                        hentBrukere(); 
                    }
                };
                liste.appendChild(div);
            });
        }

        // 3. Hent meldinger for valgt rom
        async function hentMld() {
            if (!romId) return; // Hvis ingen rom er valgt, gjør ingenting
            
            const data = await (await fetch(API + '/messages/' + romId)).json();
            const boks = document.getElementById('chatBox');
            boks.innerHTML = '';

            if(data.data.length === 0) boks.innerHTML = '<div style="margin:auto; opacity:0.5; text-align:center;">Ingen meldinger ennå.<br>Start samtalen!</div>';

            data.data.forEach(m => {
                const div = document.createElement('div');
                div.className = 'msg';
                
                // Sjekk om meldingen er tekst eller bilde
                let innhold = m.innhold.startsWith('data:image') 
                    ? `<img src="${m.innhold}" class="img-preview" onclick="window.open(this.src)">` 
                    : `<div class="content">${m.innhold}</div>`;

                // Lag HTML-en for meldingen
                div.innerHTML = `
                    <div class="msg-info"><span class="author">${m.navn}</span> <span class="time">${dato(m.timestamp)}</span></div>
                    ${innhold}
                    <span class="material-icons-round msg-del" onclick="slett('message', ${m.id})">close</span>
                `;
                boks.appendChild(div);
            });
            // Scroll automatisk til bunnen så vi ser nyeste melding
            boks.scrollTop = boks.scrollHeight;
        }

        // 4. Send melding (tekst eller bilde)
        async function send(innhold = null) {
            // Bruk enten bilde-dataen vi fikk inn, ELLER teksten i skrivefeltet
            const tekst = innhold || document.getElementById('tekstInput').value;
            
            // Enkle sjekker
            if (!brukerId) return alert("Velg bruker til høyre.");
            if (!romId) return alert("Velg kanal til venstre.");
            if (!tekst) return;

            // Send til serveren (POST)
            await fetch(API + '/message', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ user: brukerId, message: tekst, rom: romId })
            });
            
            // Tøm skrivefeltet og last inn meldinger på nytt
            document.getElementById('tekstInput').value = '';
            hentMld();
        }

        // 5. Slette ting (rom, bruker eller melding)
        async function slett(type, id) {
            await fetch(`${API}/${type}/${id}`, { method: 'DELETE' });
            
            // Hvis vi slettet rommet vi stod i, må vi nullstille
            if (type === 'room' && romId === id) romId = null;
            if (type === 'user' && brukerId === id) brukerId = null;
            
            lastInn(); // Oppdater alt på siden
        }

        // 6. Lag nye ting
        async function nyttRom() {
            const navn = prompt("Navn på ny kanal?");
            if (navn) { await fetch(API + '/room', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({navn})}); lastInn(); }
        }
        async function nyBruker() {
            const navn = prompt("Ditt navn?");
            if (navn) { await fetch(API + '/user', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({navn})}); lastInn(); }
        }

        // --- OPPSTART (Dette skjer når siden lastes) ---

        // Når man velger en fil fra datamaskinen...
        document.getElementById('filInput').onchange = function() {
            if (this.files[0]) {
                const leser = new FileReader();
                // Når filen er lest ferdig, send den som en melding
                leser.onload = (e) => send(e.target.result);
                leser.readAsDataURL(this.files[0]);
            }
            this.value = ''; // Nullstill filvelgeren
        };

        // Send melding når man trykker Enter
        document.getElementById('tekstInput').onkeypress = (e) => { if(e.key === 'Enter') send(); };
        
        // Funksjon som laster inn alt på nytt
        function lastInn() { hentRom(); hentBrukere(); hentMld(); }
        
        // Kjør med en gang
        lastInn();
        
        // Sjekk etter nye ting automatisk (hvert 3. og 5. sekund)
        setInterval(hentMld, 3000); 
        setInterval(hentBrukere, 5000); 
    </script>
</body>
</html>