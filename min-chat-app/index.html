<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatapp</title>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; /* Pene, moderne fonter */
            display: grid; /* Bruker 'grid' for å enkelt sentrere innhold */
            place-items: center; /* Sentrerer alt både vannrett og loddrett */
            min-height: 90vh; /* Siden skal være minst 90% av skjermhøyden */
            background: #f0f2f5; /* En lys grå bakgrunnsfarge, lik Facebook */
            margin: 0; /* Fjerner standard marg rundt siden */
        }
        
        /* '#chat-container' er hovedboksen som holder alt sammen */
        #chat-container { 
            width: 90%; /* Tar 90% av sidens bredde... */
            max-width: 500px; /* ...men aldri mer enn 500 piksler bred */
            border: 1px solid #ddd; /* En tynn, grå kantlinje */
            background: #fff; /* Hvit bakgrunn */
            border-radius: 8px; /* Avrundede hjørner */
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); /* En lett skygge for "dybde" */
        }
        
        /* '#chat-box' er selve vinduet hvor meldingene vises */
        #chat-box { 
            height: 400px; /* Fast høyde */
            overflow-y: auto; /* Hvis det er for mange meldinger, vis en SCROLLEBAR */
            padding: 10px; /* Litt luft på innsiden */
            border-bottom: 1px solid #eee; /* Linje mellom meldinger og skrivefeltet */
            display: flex; /* Bruker flexbox... */
            flex-direction: column; /* ...for å stable meldingene over hverandre */
        }
        
        /* '.message' er stilen for hver enkelt melding */
        .message { 
            margin-bottom: 10px; /* Avstand mellom meldingene */
            padding: 8px 12px; /* Luft inni meldingsboblen */
            background: #e6f7ff; /* En lys blåfarge */
            border-radius: 18px; /* Avrundede hjørner (mer enn chat-container) */
            max-width: 70%; /* En melding kan maks være 70% av boksens bredde */
            word-wrap: break-word; /* Hvis et ord er for langt, kutt det */
            position: relative; /* Nødvendig for å posisjonere slette-knappen */
            padding-right: 25px; /* Ekstra plass på høyre side til slette-knappen */
        }
        
        /* Styler navnet til avsenderen (det som er inni <strong>-taggen) */
        .message strong { 
            color: #0056b3; /* Mørkere blåfarge for navnet */
        }
        
        /* Stilen for tidsstempelet */
        .message .tid {
            font-size: 0.8em; /* Litt mindre skrift */
            color: #777; /* Grå farge */
            margin-right: 5px; /* Liten avstand til høyre */
        }

        /* Stilen for slette-knappen (X) */
        .delete-msg-btn {
            position: absolute; /* Plasseres "oppå" meldingen */
            top: 50%; /* Starter 50% fra toppen... */
            transform: translateY(-50%); /* ...og flyttes 50% av sin *egen* høyde opp, for perfekt sentrering */
            right: 10px; /* 10 piksler fra høyre kant */
            font-size: 1.2em; /* Litt større 'X' */
            color: #aaa; /* Lysegrå farge */
            cursor: pointer; /* Viser en 'hånd' når man holder musen over */
            font-weight: bold; /* Tykk 'X' */
            line-height: 1; /* Normal linjehøyde */
            padding: 2px 5px; /* Litt klikkeflate rundt 'X'-en */
        }
        
        /* Hva som skjer når man holder musen over slette-knappen */
        .delete-msg-btn:hover {
            color: #d9534f; /* Blir rød */
        } 

        /* '#input-area' er boksen nederst med navnefelt, rom, melding og send-knapp */
        #input-area { 
            display: flex; /* Bruker flexbox for å legge elementene pent ved siden av hverandre */
            padding: 10px; /* Luft på innsiden */
            flex-wrap: wrap; /* Hvis det ikke er plass, la elementene 'knekke' til neste linje */
            background: #f9f9f9; /* En veldig lys gråfarge */
            border-radius: 0 0 8px 8px; /* Avrunder kun de nederste hjørnene */
        }
        
        /* '#username' er feltet for "Ditt Navn" */
        #username { 
            border: 1px solid #ccc; 
            padding: 10px; 
            border-radius: 8px; 
            margin-bottom: 5px; /* Avstand under, hvis den knekker */
            flex-basis: 150px; /* Starter på 150px bredde */
            margin-right: 5px; /* Avstand til høyre */
        }
        
        /* '#room-selector' er boksen som holder 'Rom:', nedtrekksmenyen og '+' knappen */
        #room-selector { 
            display: flex; /* Legger disse elementene pent inntil hverandre */
            flex-grow: 1; /* Tar opp all ledig plass ved siden av navnefeltet */
            margin-bottom: 5px; 
        }
        
        /* Styler teksten "Rom:" */
        #room-selector label { 
            padding: 10px 5px; 
            font-size: 0.9em; 
            color: #555; 
        }
        
        /* '#rom-select' er selve nedtrekksmenyen */
        #rom-select { 
            flex-grow: 1; /* Tar opp all ledig plass i '#room-selector'-boksen */
            border: 1px solid #ccc; 
            border-radius: 8px 0 0 8px; /* Runder av hjørnet til venstre */
            padding: 10px; 
            background: #fff; 
        }
        
        /* '#create-room-btn' er '+' knappen */
        #create-room-btn { 
            flex-basis: 40px; /* Fast bredde på 40px */
            border: 1px solid #ccc; 
            background: #f0f0f0; 
            cursor: pointer; /* Viser 'hånd' */
            border-radius: 0 8px 8px 0; /* Runder av hjørnet til høyre */
            border-left: none; /* Fjerner dobbel kantlinje mot nedtrekksmenyen */
            font-size: 1.2em; /* Større '+' tegn */
        }
        
        /* '#message-input' er det store feltet man skriver meldingen i */
        #message-input { 
            flex-basis: 100%; /* Tar 100% av bredden (knekker til ny linje) */
            border: 1px solid #ccc; 
            padding: 10px; 
            border-radius: 8px; 
            margin-right: 5px; 
            margin-bottom: 5px; 
        }
        
        /* '#send-button' er 'Send'-knappen */
        #send-button { 
            background: #007bff; /* Blå farge */
            color: white; /* Hvit tekst */
            border: none; /* Ingen kantlinje */
            padding: 10px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            flex-basis: 100%; /* Tar 100% av bredden (under meldingsfeltet) */
            font-weight: bold; /* Fet tekst */
        }
        
        /* Hva som skjer når man holder musen over 'Send' */
        #send-button:hover { 
            background: #0056b3; /* Mørkere blåfarge */
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-box"></div>
        
        <div id="input-area">
            <input type="text" id="username" placeholder="Ditt Navn">
            
            <div id="room-selector">
                <label for="rom-select">Rom:</label>
                <select id="rom-select"></select> <button id="create-room-btn">+</button> </div>
            
            <input type="text" id="message-input" placeholder="Skriv en melding...">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        // --- 1. GLOBALE KONSTANTER OG ELEMENTER ---
        // Her henter vi HTML-elementene vi trenger, så vi kan jobbe med dem i koden.
        // Vi lagrer dem i const fordi de ikke skal endres.

        // Adressen til vår backend.
        const API_URL = 'http://localhost:3000';
        
        // Finner HTML-elementet med id="chat-box"
        const chatBox = document.getElementById('chat-box');
        
        // Finner HTML-elementet med id="username"
        const usernameInput = document.getElementById('username'); 
        
        // Finner HTML-elementet med id="message-input"
        const messageInput = document.getElementById('message-input');
        
        // Finner HTML-elementet med id="send-button"
        const sendButton = document.getElementById('send-button');
        
        // Finner HTML-elementet med id="rom-select"
        const romSelect = document.getElementById('rom-select');
        
        // Finner HTML-elementet med id="create-room-btn"
        const createRoomBtn = document.getElementById('create-room-btn');


        // --- 2. KJERNEFUNKSJONER (Hva appen kan gjøre) ---
        // Funksjoner er blokker med kode som kan kalles på (kjøres) når vi trenger dem.

        /**
         * En hjelpefunksjon som automatisk scroller chatteboksen til bunnen.
         * Vi kaller denne hver gang vi legger til en ny melding.
         */
        function scrollToBottom() {
            // Setter 'scrollTop' (hvor langt ned vi har scrollet)
            // til 'scrollHeight' (den totale høyden på alt innholdet).
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        /**
         * En ny hjelpefunksjon som gjør om et 'timestamp' (en dato-tekst)
         * til noe mer lesbart, som "1 dag siden" or "14:30".
         * 'async' trengs ikke her, da den ikke venter på noe.
         */
        function formaterTidSiden(timestamp) {
            // 1. Konverterer databasestrengen (f.eks. "2025-11-27 14:00:00")
            //    til et JavaScript Date-objekt.
            //    .replace(" ", "T") + "Z" er et triks for å tvinge nettleseren
            //    til å forstå tiden som universell tid (UTC).
            const tid = new Date(timestamp.replace(" ", "T") + "Z");
            
            // 2. Finner ut hva klokken er akkurat NÅ.
            const nå = new Date();
            
            // 3. Finner forskjellen i millisekunder.
            const diffMs = nå - tid;

            // 4. Definerer hvor mange millisekunder det er i ulike tidsenheter.
            const msPerDag = 1000 * 60 * 60 * 24;
            const msPerUke = msPerDag * 7;
            const msPerMaaned = msPerDag * 30.44; // Et gjennomsnitt
            const msPerÅr = msPerDag * 365.25;   // Et gjennomsnitt

            // 5. Sjekker fra største til minste tidsenhet.
            if (diffMs >= msPerÅr) {
                const år = Math.floor(diffMs / msPerÅr); // Regner ut antall år
                return år === 1 ? '1 år siden' : `${år} år siden`; // Returnerer "1 år siden" eller "X år siden"
            } else if (diffMs >= msPerMaaned) {
                const mnd = Math.floor(diffMs / msPerMaaned);
                return mnd === 1 ? '1 mnd siden' : `${mnd} mnd siden`;
            } else if (diffMs >= msPerUke) {
                const uker = Math.floor(diffMs / msPerUke);
                return uker === 1 ? '1 uke siden' : `${uker} uker siden`;
            } else if (diffMs >= msPerDag) {
                const dager = Math.floor(diffMs / msPerDag);
                return dager === 1 ? '1 dag siden' : `${dager} dager siden`;
            } else {
                // 6. Hvis det er mindre enn 1 dag siden, vis bare klokkeslettet.
                //    'toLocaleTimeString' formaterer det pent på norsk (f.eks. "14:05:10")
                return tid.toLocaleTimeString('no-NO');
            }
        }

        /**
         * Henter alle meldinger for det valgte rommet fra serveren
         * og viser dem i chatteboksen.
         * 'async' betyr at denne funksjonen kan 'vente' på at noe (som 'fetch') blir ferdig.
         */
        async function fetchMessages() {
            // Finner ut hvilket rom som er valgt i nedtrekksmenyen
            const romId = romSelect.value;
            
            // Hvis 'romId' er tom (f.eks. ingen rom valgt), vis en melding og stopp.
            if (!romId) { 
                chatBox.innerHTML = '<div style="text-align: center; color: #888; padding-top: 20px;">Velg et rom eller opprett et nytt.</div>';
                return; // Avslutter funksjonen her
            }

            // 'try...catch' er en måte å håndtere feil på.
            try {
                // 1. 'await fetch(...)' : "Vent" mens vi kaller på server-adressen for meldinger.
                const response = await fetch(`${API_URL}/messages/${romId}`);
                
                // 2. 'await response.json()' : "Vent" mens vi gjør om svaret fra serveren (som er tekst) til et JavaScript-objekt.
                const result = await response.json();
                
                // 3. Tømmer chatteboksen for gamle meldinger før vi legger inn de nye.
                chatBox.innerHTML = ''; 
                
                // 4. Sjekk om vi fikk en tom liste med meldinger
                if (result.data.length === 0) {
                    chatBox.innerHTML = '<div style="text-align: center; color: #888; padding-top: 20px;">Ingen meldinger i dette rommet ennå.</div>';
                }

                // 5. Gå gjennom hver melding ('msg') vi fikk i 'result.data'
                result.data.forEach(msg => {
                    // 6. Lag et nytt 'div'-element i minnet
                    const msgElement = document.createElement('div');
                    
                    // 7. Gi det nye elementet CSS-klassen 'message' (som vi stylet tidligere)
                    msgElement.classList.add('message');
                    
                    // 8. BRUKER DEN NYE FUNKSJONEN:
                    //    Kjør 'formaterTidSiden' for å få en pen tids-tekst
                    const formatertTid = formaterTidSiden(msg.timestamp);

                    // 9. Fyll det nye elementet med HTML-innhold.
                    //    Vi bruker dataene fra meldingen (msg.navn, msg.innhold).
                    //    VIKTIG: Vi legger til 'data-id="${msg.id}"' på slette-knappen.
                    //    Dette "gjemmer" meldingens unike ID på knappen,
                    //    så vi vet hvilken melding vi skal slette når den klikkes.
                    msgElement.innerHTML = `
                        <span class="tid">[${formatertTid}]</span> 
                        <strong>${msg.navn}:</strong> ${msg.innhold}
                        <span class="delete-msg-btn" data-id="${msg.id}">×</span>
                    `;
                    
                    // 10. Legg det nye, ferdige meldingselementet til i chatteboksen.
                    chatBox.appendChild(msgElement);
                });
                
                // 11. Scroll til bunnen for å vise den nyeste meldingen.
                scrollToBottom(); 

            } catch (error) {
                // Hvis noe gikk galt (f.eks. serveren er nede), logg feilen.
                console.error("Klarte ikke hente meldinger:", error);
            }
        }
        
        /**
         * Sender en ny melding til serveren.
         */
        async function sendMessage() {
            // 1. Hent verdien (teksten) fra input-feltene
            //    '.trim()' fjerner unødvendig mellomrom før og etter teksten.
            const user = usernameInput.value.trim(); 
            const message = messageInput.value.trim(); 
            const romId = romSelect.value;
            
            // 2. Validering: Sjekk at alle feltene er fylt ut.
            if (!user || !message || !romId) {
                alert('Du må fylle ut Navn, velge et Rom og skrive en melding.');
                return; // Avslutt funksjonen
            }
            
            // 3. Prøv å sende meldingen
            try {
                // 'await fetch(...)' : "Vent" mens vi kaller serveren.
                await fetch(`${API_URL}/message`, {
                    method: 'POST', // Vi skal SENDE/OPPRETTE data, så vi bruker 'POST'
                    headers: { 'Content-Type': 'application/json' }, // Forteller serveren at vi sender JSON-data
                    // Gjør om JavaScript-objektet vårt til en JSON-tekststreng
                    body: JSON.stringify({ user: user, message: message, rom: romId }),
                });
                
                // 4. Hvis sendingen var vellykket:
                messageInput.value = ''; // Tøm meldingsfeltet
                await fetchMessages(); // Hent alle meldingene på nytt (for å vise den vi nettopp sendte)
                
            } catch (error) {
                console.error("Klarte ikke sende melding:", error);
            }
        }
        
        /**
         * Henter listen over alle tilgjengelige rom fra serveren
         * og fyller ut nedtrekksmenyen ('<select>').
         */
        async function fetchAndPopulateRooms() {
            try {
                // 1. Hent rom-listen
                const response = await fetch(`${API_URL}/rooms`);
                const result = await response.json();
                
                // 2. Tøm nedtrekksmenyen for eventuelle gamle rom
                romSelect.innerHTML = '';
                
                // 3. Sjekk om vi fikk noen rom
                if (result.data.length === 0) {
                    // Hvis ingen rom finnes, lag et "placeholder"-valg
                    const defaultOption = document.createElement('option');
                    defaultOption.textContent = 'Ingen rom funnet';
                    defaultOption.disabled = true; // Gjør at man ikke kan velge den
                    romSelect.appendChild(defaultOption);
                } else {
                    // 4. Hvis vi fikk rom: Gå gjennom hvert rom
                    result.data.forEach(rom => {
                        // 5. Lag et '<option>'-element for hvert rom
                        const option = document.createElement('option');
                        option.value = rom.id; // Verdien (som sendes til serveren) er ID-en
                        option.textContent = rom.navn; // Teksten (som brukeren ser) er navnet
                        romSelect.appendChild(option); // Legg til i nedtrekksmenyen
                    });
                }
                
                // 5. Nå som rom-listen er lastet, hent meldingene for det rommet som er valgt (automatisk det første i listen)
                await fetchMessages(); 
                
            } catch (error) {
                console.error("Klarte ikke hente rom:", error);
            }
        }

        /**
         * Håndterer logikken for å lage et nytt rom.
         */
        async function handleCreateRoom() {
            // 1. Spør brukeren om et navn via en enkel popup-boks
            const newRomName = prompt("Hva skal det nye rommet hete?");
            
            // 2. Hvis brukeren trykket "Avbryt" eller ikke skrev noe, stopp.
            if (!newRomName || newRomName.trim() === '') return;
            
            try {
                // 3. Send det nye romnavnet til serveren for å opprette det
                const response = await fetch(`${API_URL}/room`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ navn: newRomName.trim() })
                });
                
                // 4. Få tilbake det nye rom-objektet fra serveren (inkl. den nye ID-en)
                const newRom = await response.json(); 
                
                // 5. Sjekk om rommet allerede finnes i listen (usannsynlig, men god sjekk)
                //    '[...romSelect.options]' gjør om listen til en array vi kan sjekke
                const romFinnes = [...romSelect.options].some(opt => opt.value == newRom.id);
                
                if (!romFinnes) {
                    // 6. Lag et nytt '<option>'-element for det nye rommet
                    const newOption = document.createElement('option');
                    newOption.value = newRom.id;
                    newOption.textContent = newRom.navn;
                    romSelect.appendChild(newOption);
                    
                    // 7. Hvis "Ingen rom funnet"-teksten er der, fjern den.
                    const defaultOpt = romSelect.querySelector('option[disabled]');
                    if (defaultOpt) defaultOpt.remove();
                }
                
                // 8. Velg det nye rommet automatisk i nedtrekksmenyen
                romSelect.value = newRom.id; 
                
                // 9. Hent meldinger for det nye rommet (som vil være tomt)
                fetchMessages(); 
                
            } catch (error) {
                console.error("Feil ved oppretting av rom:", error);
                alert("En feil oppstod. Kanskje det rom-navnet finnes fra før?");
            }
        }

        /**
         * Kaller på slette-API-et for en gitt meldings-ID.
         */
        async function deleteMessage(id) {
            // Logger til konsollen at vi prøver å slette (bra for feilsøking)
            console.log(`Prøver å slette ID: ${id}`);

            try {
                // 1. Kall på serveren med 'DELETE'-metoden.
                //    Legg merke til at ID-en er en del av URL-en.
                await fetch(`${API_URL}/message/${id}`, {
                    method: 'DELETE'
                });
                
                // 2. Den enkleste måten å oppdatere på: hent alle meldinger på nytt.
                //    Dette vil tegne opp chatteboksen på nytt, uten den slettede meldingen.
                await fetchMessages(); 
                
            } catch (error) {
                console.error("Klarte ikke slette melding:", error);
            }
        }


        // --- 3. EVENT LISTENERS (Lyttere) ---
        // Her kobler vi funksjonene våre til faktiske brukerhandlinger (klikk, tastetrykk).

        // Kjør 'sendMessage'-funksjonen når noen KLIKKER på 'sendButton'
        sendButton.addEventListener('click', sendMessage); 
        
        // Kjør 'handleCreateRoom'-funksjonen når noen KLIKKER på 'createRoomBtn'
        createRoomBtn.addEventListener('click', handleCreateRoom); 
        
        // Kjør 'fetchMessages'-funksjonen når brukeren ENDRER rom i nedtrekksmenyen
        romSelect.addEventListener('change', fetchMessages); 
        
        // Lytt etter TASTETRYKK i 'messageInput'-feltet
        messageInput.addEventListener('keypress', (e) => {
            // Sjekk om tasten som ble trykket var 'Enter'
            if (e.key === 'Enter') {
                sendMessage(); // I så fall, kjør 'sendMessage'
            }
        });
        
        // LYTTER ETTER KLIKK PÅ *HELE* CHATBOXEN (Dette kalles Event Delegation)
        // I stedet for å legge en lytter på *hver* slette-knapp (som kan være hundrevis),
        // legger vi én lytter på forelderen ('chatBox').
        chatBox.addEventListener('click', (e) => {
            // 'e.target' er det *spesifikke* elementet som ble klikket på (f.eks. en 'strong', en 'span' eller slette-knappen)
            console.log("KLIKK PÅ CHATBOX");
            
            // Sjekk om tingen vi klikket på har CSS-klassen 'delete-msg-btn'
            if (e.target.classList.contains('delete-msg-btn')) {
                console.log("Fant slette-knapp!");
                // Hent 'data-id'-attributtet vi lagret på knappen tidligere
                const id = e.target.dataset.id;
                // Kall på slettefunksjonen med denne ID-en
                deleteMessage(id);
            }
        });

        // --- 4. OPPSTART ---
        // Kode som kjører én gang når siden lastes inn.

        /**
         * 'init' (initialize) er en funksjon som starter hele applikasjonen.
         */
        async function init() {
            // 1. Hent rom-listen og fyll nedtrekksmenyen..
            await fetchAndPopulateRooms(); 
            
            // 2. Sett opp en timer som automatisk henter nye meldinger
            //    hvert 3 sekund.
            //    Dette gjør at chatten oppdateres live hvis andre skriver noe.
            setInterval(fetchMessages, 3000); 
        }
        
        // Kjør oppstartsfunksjonen!
        init(); 

    </script>
</body>
</html>